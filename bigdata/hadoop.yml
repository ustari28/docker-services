FROM library/ubuntu
#install new software
RUN echo 'debconf debconf/frontend select Noninteractive' | debconf-set-selections
RUN apt-get update && apt-get install -y openssh-server pdsh libaio1 libnuma1
RUN mkdir /downloads
RUN chmod 777 /downloads
RUN mkdir -p /warehouse/hive
RUN mkdir -p /usr/local
#Create users
RUN addgroup bigdata
RUN useradd -ms /bin/bash -g bigdata -d /home/bigdata -m bigdata
RUN useradd -ms /bin/bash -g bigdata -d /home/hadoop -m hadoop
RUN useradd -ms /bin/bash -g bigdata -d /home/hive -m hive
#RUN useradd -s /bin/false -g bigdata -d /usr/local/mysql -m mysql
#set passwords
#USER bigdata
#RUN echo -e "bigdata$2018\nbigdata$2018" | passwd bigdata
#USER hive
#RUN echo -e "hive$2018\nhive$2018" | passwd hive
#USER hadoop
#RUN echo -e "hadoop$2018\nhadoop$2018" | passwd hadoop
#run custom installations
WORKDIR /downloads
RUN chown -R hive /warehouse
#COPY my.cnf /usr/local/mysql
#RUN chown -R mysql /usr/local/mysql/my.cnf
#RUN chmod 777 /tmp
#USER mysql
#RUN wget -q https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.21-linux-glibc2.12-x86_64.tar.gz
#COPY mysql-5.7.21-linux-glibc2.12-x86_64.tar.gz /downloads/
#RUN tar -xf mysql-5.7.21-linux-glibc2.12-x86_64.tar.gz
#RUN rm /downloads/mysql-5.7.21-linux-glibc2.12-x86_64.tar.gz
#RUN cp -R ./mysql-5.7.21-linux-glibc2.12-x86_64/** /usr/local/mysql
#RUN rm -rf ./mysql-5.7.21-linux-glibc2.12-x86_64/
# RUN mkdir /usr/local/mysql/mysql-files
# RUN mkdir /usr/local/mysql/mysqld
# RUN mkdir /usr/local/mysql/data
# RUN mkdir /usr/local/mysql/rsa
# RUN mkdir /usr/local/mysql/logs
# RUN chmod 750 /usr/local/mysql/mysql-files
# RUN chmod 750 /usr/local/mysql/mysqld
# RUN chmod 750 /usr/local/mysql/data
# RUN chmod 750 /usr/local/mysql/rsa
# RUN chmod 750 /usr/local/mysql/logs
# RUN /usr/local/mysql/bin/mysqld --defaults-file=/usr/local/mysql/my.cnf --initialize-insecure --user=mysql
# RUN /usr/local/mysql/bin/mysql_ssl_rsa_setup --datadir=/usr/local/mysql/rsa
# RUN /usr/local/mysql/bin/mysqld_safe --user=mysql --defaults-file=/usr/local/mysql/my.cnf
# RUN /usr/local/mysql/bin/mysql -u root --skip-password -e "ALTER USER 'root'@'localhost' IDENTIFIED BY 'admin';" --host localhost
USER hive
#RUN wget -q http://apache.rediris.es/hive/hive-2.3.2/apache-hive-2.3.2-bin.tar.gz
COPY apache-hive-2.3.2-bin.tar.gz /downloads/
RUN tar -xf apache-hive-2.3.2-bin.tar.gz
RUN rm apache-hive-2.3.2-bin.tar.gz
RUN cp -R ./apache-hive-2.3.2-bin/** /home/hive
RUN rm -rf /downloas/apache-hive-2.3.2-bin/
COPY hive-site.xml /home/hive/conf/hive-site.xml
USER hadoop
#RUN wget -q http://apache.rediris.es/hadoop/common/hadoop-3.0.0/hadoop-3.0.0.tar.gz
COPY hadoop-3.0.0.tar.gz /downloads
COPY jdk-8u161-linux-x64.tar.gz .

RUN tar -xf hadoop-3.0.0.tar.gz
RUN cp -R ./hadoop-3.0.0/** /home/hadoop
RUN rm -rf ./hadoop-3.0.0
RUN rm /downloads/hadoop-3.0.0.tar.gz
COPY core-site.xml /home/hadoop/etc/hadoop/core-site.xml
COPY hdfs-site.xml /home/hadoop/etc/hadoop/hdfs-site.xml
COPY hadoop-env.sh /home/hadoop/etc/hadoop/hadoop-env.sh
USER bigdata
RUN mkdir /home/bigdata/java
RUN tar -xf jdk-8u161-linux-x64.tar.gz
RUN rm /downloads/jdk-8u161-linux-x64.tar.gz
RUN cp -R ./jdk1.8.0_161/** /home/bigdata/java
RUN rm -rf ./jdk1.8.0_161
COPY --chown=bigdata:bigdata start_all.sh /home/bigdata/
RUN chmod 755 /home/bigdata/start_all.sh
#configuration environment vars
ENV JAVA_HOME=/home/bigdata/java
ENV PDSH_RCMD_TYPE=ssh
ENV HIVE_HOME=/home/hive
ENV HADOOP_HOME=/home/hadoop
# ENV MYSQL_HOME=/home/mysql
ENV PATH=$JAVA_HOME/bin:$HIVE_HOME/bin:$HADOOP_HOME/bin
#Ports hive
EXPOSE 2181 8081 8082 10001 9000 9083 9870 8088 19888
#starting up process

USER bigdata
CMD ["/home/bigdata/start_all.sh"]
#CMD ["hive --service metastore"]
#CMD ["hive --service hiveserver2"]

